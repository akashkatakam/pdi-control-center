{% extends "base.html" %}

{% block title %}Transfer Stock - PDI Control Center{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
        <div>
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">üöö Transfer Stock</h1>
            <p class="text-sm text-gray-600 mt-1">Scan multiple vehicles for batch transfer</p>
        </div>
        <a href="/logistics/receive" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm font-medium text-center">
            ‚Üê Back to Receive
        </a>
    </div>

    <!-- Batch Summary Card -->
    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl shadow-xl p-6 text-white">
        <div class="flex justify-between items-center">
            <div>
                <p class="text-blue-100 text-sm mb-1">Vehicles in Batch</p>
                <p class="text-5xl font-bold" id="batchCount">0</p>
            </div>
            <div class="text-right">
                <button
                    onclick="clearBatch()"
                    class="px-4 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg text-sm font-medium backdrop-blur-sm transition"
                >
                    üóëÔ∏è Clear All
                </button>
            </div>
        </div>
    </div>

    <div class="grid lg:grid-cols-2 gap-6">
        <!-- Left: QR Scanner -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="bg-gray-900 px-4 sm:px-6 py-4 text-white">
                <h2 class="text-lg font-semibold flex items-center">
                    <span class="text-2xl mr-2">üì∑</span>
                    Scan Vehicles
                </h2>
            </div>

            <div class="p-4 sm:p-6">
                <!-- Camera View -->
                <div class="relative mb-4">
                    <div id="qr-reader" class="w-full rounded-lg overflow-hidden border-4 border-blue-500 shadow-xl" style="min-height: 300px;"></div>

                    <!-- Manual Entry Toggle -->
                    <button
                        type="button"
                        onclick="toggleManualEntry()"
                        class="absolute bottom-4 right-4 bg-white px-4 py-2 rounded-lg shadow-lg text-sm font-medium text-gray-700 hover:bg-gray-50"
                    >
                        ‚å®Ô∏è Manual
                    </button>
                </div>

                <!-- Manual Entry -->
                <div id="manualEntry" class="hidden mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        üî¢ Enter Chassis Number
                    </label>
                    <div class="flex gap-2">
                        <input
                            type="text"
                            id="manualChassisInput"
                            placeholder="Chassis number..."
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm"
                            onkeypress="if(event.key === 'Enter') { event.preventDefault(); processManualEntry(); }"
                        >
                        <button
                            type="button"
                            onclick="processManualEntry()"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium text-sm"
                        >
                            Add
                        </button>
                    </div>
                </div>

                <!-- Last Scanned -->
                <div id="lastScanned" class="hidden bg-green-50 border-2 border-green-400 rounded-lg p-3 mb-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs text-green-600 font-medium">‚úÖ Added to batch</p>
                            <p class="text-sm font-semibold text-green-900" id="lastScannedChassis">-</p>
                        </div>
                        <button type="button" onclick="removeLastScanned()" class="text-red-600 hover:text-red-700 font-medium text-sm">
                            Remove
                        </button>
                    </div>
                </div>

                <!-- Instructions -->
                <div class="bg-blue-50 rounded-lg p-4">
                    <p class="text-sm text-blue-900 font-medium mb-2">üìã How to use:</p>
                    <ol class="text-sm text-blue-800 space-y-1 list-decimal list-inside">
                        <li>Scan QR codes of all vehicles</li>
                        <li>Each scan adds to the batch</li>
                        <li>Review list on the right ‚Üí</li>
                        <li>Select destination and transfer</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- Right: Batch List & Transfer -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="bg-indigo-600 px-4 sm:px-6 py-4 text-white">
                <h2 class="text-lg font-semibold flex items-center justify-between">
                    <span class="flex items-center">
                        <span class="text-2xl mr-2">üì¶</span>
                        Batch Review
                    </span>
                    <span class="text-sm bg-white bg-opacity-20 px-3 py-1 rounded-full">
                        <span id="listCount">0</span> vehicles
                    </span>
                </h2>
            </div>

            <div class="p-4 sm:p-6">
                <!-- Empty State -->
                <div id="emptyState" class="text-center py-12 text-gray-400">
                    <div class="text-5xl mb-3">üì¶</div>
                    <p class="text-sm font-medium">No vehicles scanned yet</p>
                    <p class="text-xs mt-1">Start scanning to add vehicles</p>
                </div>

                <!-- Vehicle List -->
                <div id="vehicleListContainer" class="hidden">
                    <div id="vehicleList" class="space-y-2 max-h-80 overflow-y-auto mb-6">
                        <!-- Vehicles will be added here dynamically -->
                    </div>

                    <!-- Transfer Form -->
                    <form method="POST" action="/logistics/transfer-batch" id="transferForm" class="space-y-4 border-t pt-4">
                        <input type="hidden" name="chassis_numbers" id="chassisNumbers">

                        <!-- Destination Branch -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                üìç Transfer To
                            </label>
                            <select name="destination_branch" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-base font-medium">
                                <option value="">Select destination...</option>
                                {% for branch in branches %}
                                <option value="{{ branch.Branch_ID }}">{{ branch.Branch_Name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Load Reference -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                üîñ DC No.
                            </label>
                            <input
                                type="text"
                                name="dc_number"
                                required
                                placeholder="e.g., DC123456"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-base uppercase"
                                oninput="this.value = this.value.toUpperCase()"
                            >

                            <p class="text-xs text-gray-500 mt-1">üí° This identifies the truck/batch</p>
                        </div>

                        <button
                            type="submit"
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-lg transition shadow-lg text-base"
                        >
                            ‚úàÔ∏è Transfer <span id="transferCount">0</span> Vehicles
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

<!-- Include QR Scanner Library -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
let html5QrCode;
let scannedVehicles = [];
let lastScannedChassis = null;
let isProcessing = false;

// Initialize QR Scanner
function initScanner() {
    html5QrCode = new Html5Qrcode("qr-reader");

    html5QrCode.start(
        { facingMode: "environment" },
        {
            fps: 10,
            qrbox: { width: 250, height: 250 }
        },
        onScanSuccess,
        onScanFailure
    ).catch(err => {
        console.error("Camera error:", err);
        showToast("üì∑ Camera not available. Use manual entry.", "warning");
        document.getElementById('manualEntry').classList.remove('hidden');
    });
}

function onScanSuccess(decodedText, decodedResult) {
    if (isProcessing) return;

    console.log("QR Code detected:", decodedText);

    // Check if already scanned
    if (scannedVehicles.find(v => v.chassis_no === decodedText)) {
        showToast("‚ö†Ô∏è Already in batch: " + decodedText.substring(0, 10), "warning");
        return;
    }

    // Fetch and add vehicle
    isProcessing = true;
    fetchVehicleDetails(decodedText);
}

function onScanFailure(error) {
    // Ignore scanning errors (happens frequently)
}

async function fetchVehicleDetails(chassisNo) {
    try {
        const response = await fetch(`/logistics/vehicle-details?chassis_no=${encodeURIComponent(chassisNo)}`);
        const data = await response.json();

        if (data.error) {
            showToast("‚ùå " + data.error, "error");
        } else {
            addVehicleToBatch(data);
        }
    } catch (error) {
        console.error("Fetch error:", error);
        showToast("‚ùå Failed to fetch vehicle details", "error");
    } finally {
        isProcessing = false;
    }
}

function addVehicleToBatch(vehicle) {
    scannedVehicles.push(vehicle);
    lastScannedChassis = vehicle.chassis_no;
    updateUI();
    showToast("‚úÖ Added: " + vehicle.model, "success");

    // Show last scanned
    document.getElementById('lastScanned').classList.remove('hidden');
    document.getElementById('lastScannedChassis').textContent = vehicle.chassis_no + " - " + vehicle.model;

    console.log("Current batch:", scannedVehicles);
}

function removeVehicle(chassisNo) {
    scannedVehicles = scannedVehicles.filter(v => v.chassis_no !== chassisNo);
    if (lastScannedChassis === chassisNo) {
        lastScannedChassis = null;
        document.getElementById('lastScanned').classList.add('hidden');
    }
    updateUI();
    showToast("üóëÔ∏è Removed from batch", "info");
}

function removeLastScanned() {
    if (lastScannedChassis) {
        removeVehicle(lastScannedChassis);
    }
}

function clearBatch() {
    if (scannedVehicles.length === 0) {
        showToast("‚ÑπÔ∏è Batch is already empty", "info");
        return;
    }

    if (confirm(`Clear all ${scannedVehicles.length} vehicles from batch?`)) {
        scannedVehicles = [];
        lastScannedChassis = null;
        document.getElementById('lastScanned').classList.add('hidden');
        updateUI();
        showToast("üóëÔ∏è Batch cleared", "info");
    }
}

function updateUI() {
    const count = scannedVehicles.length;

    console.log("Updating UI with", count, "vehicles");

    // Update counts
    document.getElementById('batchCount').textContent = count;
    document.getElementById('listCount').textContent = count;
    document.getElementById('transferCount').textContent = count;

    const emptyState = document.getElementById('emptyState');
    const vehicleListContainer = document.getElementById('vehicleListContainer');
    const vehicleList = document.getElementById('vehicleList');

    if (count === 0) {
        // Show empty state
        emptyState.classList.remove('hidden');
        vehicleListContainer.classList.add('hidden');
    } else {
        // Show vehicle list
        emptyState.classList.add('hidden');
        vehicleListContainer.classList.remove('hidden');

        // Build vehicle list HTML
        vehicleList.innerHTML = scannedVehicles.map((v, index) => `
            <div class="border-2 border-gray-200 rounded-lg p-3 hover:border-blue-300 transition bg-white">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center mb-1">
                            <span class="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs font-bold mr-2">
                                ${index + 1}
                            </span>
                            <span class="font-semibold text-gray-900 text-sm">${v.chassis_no}</span>
                        </div>
                        <div class="text-xs text-gray-600 ml-8">
                            <div>${v.model} - ${v.variant}</div>
                            <div class="text-gray-500">${v.color}</div>
                        </div>
                    </div>
                    <button
                        type="button"
                        onclick="removeVehicle('${v.chassis_no}')"
                        class="text-red-600 hover:text-red-700 ml-2 p-1"
                        title="Remove"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
        `).join('');
    }

    // Update hidden input
    document.getElementById('chassisNumbers').value = scannedVehicles.map(v => v.chassis_no).join(',');
}

function toggleManualEntry() {
    const manualEntry = document.getElementById('manualEntry');
    manualEntry.classList.toggle('hidden');

    if (!manualEntry.classList.contains('hidden')) {
        document.getElementById('manualChassisInput').focus();
    }
}

function processManualEntry() {
    const input = document.getElementById('manualChassisInput');
    const chassisNo = input.value.trim();

    if (!chassisNo) {
        showToast("‚ö†Ô∏è Enter chassis number", "warning");
        return;
    }

    // Check if already scanned
    if (scannedVehicles.find(v => v.chassis_no === chassisNo)) {
        showToast("‚ö†Ô∏è Already in batch", "warning");
        input.value = '';
        return;
    }

    isProcessing = true;
    fetchVehicleDetails(chassisNo);
    input.value = '';
}

function showToast(message, type = "info") {
    const colors = {
        success: "bg-green-500",
        error: "bg-red-500",
        warning: "bg-orange-500",
        info: "bg-blue-500"
    };

    const toast = document.createElement('div');
    toast.className = `${colors[type]} text-white px-6 py-3 rounded-lg shadow-xl transform transition-all duration-300`;
    toast.textContent = message;

    const container = document.getElementById('toastContainer');
    container.appendChild(toast);

    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Handle success/error messages from URL parameters
document.addEventListener('DOMContentLoaded', function() {
    console.log("Page loaded, initializing scanner...");
    initScanner();

    // Check for success/error in URL
    const urlParams = new URLSearchParams(window.location.search);

    if (urlParams.get('success') === 'true') {
        const count = urlParams.get('count') || '0';
        const dc = urlParams.get('dc') || '';

        // Show success message
        showSuccessModal(count, dc);

        // Clean URL (remove query parameters)
        window.history.replaceState({}, document.title, window.location.pathname);
    } else if (urlParams.get('error')) {
        const error = urlParams.get('error');
        const errorMessages = {
            'destination_required': 'Please select a destination branch',
            'dc_required': 'DC Number is required',
            'no_vehicles': 'No vehicles selected for transfer',
            'no_branch': 'Branch information not found',
            'same_branch': 'Cannot transfer to the same branch',
            'transfer_failed': 'Transfer failed. No vehicles were processed',
            'invalid_data': 'Invalid data format',
            'server_error': 'Server error occurred. Please try again'
        };

        showToast('‚ùå ' + (errorMessages[error] || 'An error occurred'), 'error');

        // Clean URL
        window.history.replaceState({}, document.title, window.location.pathname);
    }
});

function showSuccessModal(count, dc) {
    // Create success modal overlay
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 animate-fade-in';
    modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md mx-4 animate-scale-in">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4">
                    <svg class="h-10 w-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <h3 class="text-2xl font-bold text-gray-900 mb-2">Transfer Complete!</h3>
                <p class="text-gray-600 mb-1">Successfully transferred</p>
                <p class="text-4xl font-bold text-green-600 mb-2">${count}</p>
                <p class="text-gray-600 mb-4">vehicle${count != '1' ? 's' : ''}</p>
                <div class="bg-blue-50 rounded-lg p-3 mb-6">
                    <p class="text-sm text-blue-900 font-medium">DC Number</p>
                    <p class="text-lg font-bold text-blue-700">${dc}</p>
                </div>
                <button
                    onclick="closeSuccessModal()"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition shadow-lg"
                >
                    Start New Transfer
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);

    // Auto close after 5 seconds
    setTimeout(() => {
        closeSuccessModal();
    }, 5000);
}

function closeSuccessModal() {
    const modal = document.querySelector('.fixed.inset-0');
    if (modal) {
        modal.classList.add('animate-fade-out');
        setTimeout(() => modal.remove(), 300);
    }
}

</script>

<style>
#qr-reader video {
    width: 100% !important;
    height: auto !important;
    border-radius: 0.5rem;
}

#qr-reader {
    background: #000;
}

/* Smooth scrolling for vehicle list */
#vehicleList {
    scroll-behavior: smooth;
}

/* Toast animations */
#toastContainer > div {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
}

@keyframes scaleIn {
    from {
        opacity: 0;
        transform: scale(0.9);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

.animate-fade-in {
    animation: fadeIn 0.3s ease-out;
}

.animate-fade-out {
    animation: fadeOut 0.3s ease-out;
}

.animate-scale-in {
    animation: scaleIn 0.3s ease-out;
}

</style>
{% endblock %}
