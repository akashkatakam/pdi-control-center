{% extends "base.html" %}

{% block title %}Inventory - PDI Control Center{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 -m-6 p-6">
    <!-- Top Bar -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Inventory</h1>
            <p class="text-sm text-gray-500">{{ branch_name }}</p>
        </div>
        <div class="flex space-x-3">
            <button onclick="window.print()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm font-medium">
                üìÑ Export
            </button>
            <a href="/inventory/locator" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium">
                Search Vehicles
            </a>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow-sm p-4 border-l-4 border-blue-500">
            <p class="text-sm text-gray-600 mb-1">Total Stock</p>
            <p class="text-3xl font-bold text-gray-900" id="statTotal">{{ total_vehicles }}</p>
        </div>
        <div class="bg-white rounded-lg shadow-sm p-4 border-l-4 border-green-500">
            <p class="text-sm text-gray-600 mb-1">Models</p>
            <p class="text-3xl font-bold text-gray-900" id="statModels">{{ total_models }}</p>
        </div>
        <div class="bg-white rounded-lg shadow-sm p-4 border-l-4 border-purple-500">
            <p class="text-sm text-gray-600 mb-1">Branches</p>
            <p class="text-3xl font-bold text-gray-900" id="statBranches">{{ branch_count }}</p>
        </div>
        <div class="bg-white rounded-lg shadow-sm p-4 border-l-4 border-orange-500">
            <p class="text-sm text-gray-600 mb-1">Variants</p>
            <p class="text-3xl font-bold text-gray-900" id="statVariants">-</p>
        </div>
    </div>

    <!-- Control Bar -->
    <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
        <div class="flex items-center space-x-4">
            <!-- Search -->
            <div class="flex-1">
                <input
                    type="text"
                    id="searchBox"
                    placeholder="üîç Search by model, variant, color..."
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    oninput="applyAllFilters()"
                >
            </div>

            <!-- Branch Multi-Select Filter -->
            <div class="relative">
                <button
                    type="button"
                    id="branchFilterBtn"
                    class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 hover:bg-gray-50 min-w-[200px] text-left flex justify-between items-center"
                    onclick="toggleBranchDropdown()"
                >
                    <span id="branchFilterText">Khammam</span>
                    <svg class="w-4 h-4 ml-2 transition-transform" id="branchDropdownArrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>

                <div id="branchDropdown" class="hidden absolute z-50 mt-2 w-64 bg-white border border-gray-300 rounded-lg shadow-xl">
                    <div class="p-3 border-b bg-gray-50 flex justify-between">
                        <button onclick="selectAllBranches()" class="text-xs text-blue-600 hover:text-blue-700 font-medium">Select All</button>
                        <button onclick="clearAllBranches()" class="text-xs text-gray-600 hover:text-gray-700 font-medium">Clear All</button>
                    </div>
                    <div class="max-h-64 overflow-y-auto p-2">
                        {% for branch in managed_branches %}
                        <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                            <input
                                type="checkbox"
                                class="branch-checkbox w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                                value="{{ branch.Branch_Name }}"
                                {% if branch.Branch_Name == 'Khammam' %}checked{% endif %}
                                onchange="updateBranchFilter()"
                            >
                            <span class="ml-3 text-sm text-gray-700">{{ branch.Branch_Name }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    <div class="p-3 border-t bg-gray-50">
                        <button onclick="applyBranchFilter()" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium">
                            Apply Filter
                        </button>
                    </div>
                </div>
            </div>

            <!-- View Toggle -->
            <div class="flex bg-gray-100 rounded-lg p-1">
                <button onclick="switchView('grouped')" id="btnGrouped" class="px-4 py-2 text-sm font-medium rounded-md bg-white shadow-sm">
                    Grouped
                </button>
                <button onclick="switchView('flat')" id="btnFlat" class="px-4 py-2 text-sm font-medium rounded-md text-gray-600 hover:text-gray-900">
                    List
                </button>
            </div>
        </div>
    </div>

    <!-- Grouped View (Default) - Accordion Style -->
    <div id="groupedView" class="space-y-3">
        {% for model, items in stock_by_model.items() %}
        <div class="bg-white rounded-lg shadow-sm overflow-hidden model-group" data-model="{{ model }}">
            <div class="flex items-center justify-between px-6 py-3 bg-gray-50 border-b cursor-pointer hover:bg-gray-100" onclick="toggleAccordion(this)">
                <div class="flex items-center space-x-3">
                    <svg class="w-4 h-4 text-gray-400 transition-transform chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                    <span class="font-semibold text-gray-900">{{ model }}</span>
                </div>
                <span class="px-3 py-1 bg-blue-100 text-blue-800 text-sm font-semibold rounded-full model-count">
                    {{ items|sum(attribute='stock') }}
                </span>
            </div>
            <div class="group-content hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-2 text-left text-xs font-medium text-gray-500 uppercase">Branch</th>
                            <th class="px-6 py-2 text-left text-xs font-medium text-gray-500 uppercase">Variant</th>
                            <th class="px-6 py-2 text-left text-xs font-medium text-gray-500 uppercase">Color</th>
                            <th class="px-6 py-2 text-right text-xs font-medium text-gray-500 uppercase">Qty</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-100">
                        {% for item in items %}
                        <tr class="hover:bg-gray-50 stock-row" data-branch="{{ item.branch }}" data-variant="{{ item.variant }}" data-color="{{ item.color }}">
                            <td class="px-6 py-3 text-sm text-gray-700">{{ item.branch }}</td>
                            <td class="px-6 py-3 text-sm text-gray-600">{{ item.variant }}</td>
                            <td class="px-6 py-3 text-sm text-gray-600">{{ item.color }}</td>
                            <td class="px-6 py-3 text-sm text-right">
                                <span class="font-semibold text-gray-900 stock-value">{{ item.stock }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Flat View (Hidden by default) -->
    <div id="flatView" class="hidden bg-white rounded-lg shadow-sm overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50 sticky top-0">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100" onclick="sortFlat(0)">
                        Model <span class="sort-indicator">‚Üï</span>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Variant</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Color</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100" onclick="sortFlat(3)">
                        Branch <span class="sort-indicator">‚Üï</span>
                    </th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100" onclick="sortFlat(4)">
                        Stock <span class="sort-indicator">‚Üï</span>
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="flatTableBody">
                {% for model, items in stock_by_model.items() %}
                    {% for item in items %}
                    <tr class="hover:bg-gray-50 flat-row" data-model="{{ model }}" data-branch="{{ item.branch }}" data-variant="{{ item.variant }}" data-color="{{ item.color }}">
                        <td class="px-6 py-3 text-sm font-semibold text-gray-900">{{ model }}</td>
                        <td class="px-6 py-3 text-sm text-gray-600">{{ item.variant }}</td>
                        <td class="px-6 py-3 text-sm text-gray-600">{{ item.color }}</td>
                        <td class="px-6 py-3 text-sm text-gray-700">{{ item.branch }}</td>
                        <td class="px-6 py-3 text-sm text-right">
                            <span class="font-semibold text-gray-900 stock-value">{{ item.stock }}</span>
                        </td>
                    </tr>
                    {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- No Results -->
    <div id="noResults" class="hidden bg-white rounded-lg shadow-sm p-12 text-center">
        <div class="text-4xl mb-3">üîç</div>
        <p class="text-gray-600 mb-2">No inventory found</p>
        <button onclick="clearFilters()" class="text-blue-600 hover:text-blue-700 text-sm font-medium">Clear filters</button>
    </div>
</div>

<script>
let currentView = 'grouped';
let sortOrder = {};

// Toggle accordion - close others when opening one
function toggleAccordion(header) {
    const currentGroup = header.parentElement;
    const currentContent = header.nextElementSibling;
    const currentChevron = header.querySelector('.chevron');
    const isOpen = !currentContent.classList.contains('hidden');

    // Close all other groups
    document.querySelectorAll('.model-group').forEach(group => {
        if (group !== currentGroup) {
            const content = group.querySelector('.group-content');
            const chevron = group.querySelector('.chevron');
            content.classList.add('hidden');
            chevron.classList.remove('rotate-90');
        }
    });

    // Toggle current group
    if (isOpen) {
        currentContent.classList.add('hidden');
        currentChevron.classList.remove('rotate-90');
    } else {
        currentContent.classList.remove('hidden');
        currentChevron.classList.add('rotate-90');
    }
}

// Branch filter dropdown
function toggleBranchDropdown() {
    const dropdown = document.getElementById('branchDropdown');
    const arrow = document.getElementById('branchDropdownArrow');
    dropdown.classList.toggle('hidden');
    arrow.classList.toggle('rotate-180');
}

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
    const dropdown = document.getElementById('branchDropdown');
    const btn = document.getElementById('branchFilterBtn');
    if (!dropdown.contains(e.target) && e.target !== btn && !btn.contains(e.target)) {
        dropdown.classList.add('hidden');
        document.getElementById('branchDropdownArrow').classList.remove('rotate-180');
    }
});

function selectAllBranches() {
    document.querySelectorAll('.branch-checkbox').forEach(cb => cb.checked = true);
    updateBranchFilter();
}

function clearAllBranches() {
    document.querySelectorAll('.branch-checkbox').forEach(cb => cb.checked = false);
    updateBranchFilter();
}

function updateBranchFilter() {
    const selected = Array.from(document.querySelectorAll('.branch-checkbox:checked'));
    const text = document.getElementById('branchFilterText');

    if (selected.length === 0) {
        text.textContent = 'Select branches...';
    } else if (selected.length === 1) {
        text.textContent = selected[0].value;
    } else if (selected.length === document.querySelectorAll('.branch-checkbox').length) {
        text.textContent = 'All Branches';
    } else {
        text.textContent = `${selected.length} branches selected`;
    }
}

function applyBranchFilter() {
    toggleBranchDropdown();
    applyAllFilters();
}

// Switch between views
function switchView(view) {
    currentView = view;
    const groupedView = document.getElementById('groupedView');
    const flatView = document.getElementById('flatView');
    const btnGrouped = document.getElementById('btnGrouped');
    const btnFlat = document.getElementById('btnFlat');

    if (view === 'grouped') {
        groupedView.classList.remove('hidden');
        flatView.classList.add('hidden');
        btnGrouped.classList.add('bg-white', 'shadow-sm');
        btnGrouped.classList.remove('text-gray-600');
        btnFlat.classList.remove('bg-white', 'shadow-sm');
        btnFlat.classList.add('text-gray-600');
    } else {
        groupedView.classList.add('hidden');
        flatView.classList.remove('hidden');
        btnFlat.classList.add('bg-white', 'shadow-sm');
        btnFlat.classList.remove('text-gray-600');
        btnGrouped.classList.remove('bg-white', 'shadow-sm');
        btnGrouped.classList.add('text-gray-600');
    }
}

// Apply all filters
function applyAllFilters() {
    const searchText = document.getElementById('searchBox').value.toLowerCase();
    const selectedBranches = Array.from(document.querySelectorAll('.branch-checkbox:checked')).map(cb => cb.value);

    let totalStock = 0;
    let visibleModels = new Set();
    let visibleBranches = new Set();
    let visibleVariants = new Set();
    let hasVisibleRows = false;

    if (currentView === 'grouped') {
        document.querySelectorAll('.model-group').forEach(group => {
            const model = group.dataset.model;
            let groupStock = 0;
            let groupVisible = false;

            group.querySelectorAll('.stock-row').forEach(row => {
                const branch = row.dataset.branch;
                const variant = row.dataset.variant;
                const color = row.dataset.color;
                const stock = parseInt(row.querySelector('.stock-value').textContent);

                const matchesSearch = !searchText ||
                    model.toLowerCase().includes(searchText) ||
                    variant.toLowerCase().includes(searchText) ||
                    color.toLowerCase().includes(searchText) ||
                    branch.toLowerCase().includes(searchText);

                const matchesBranch = selectedBranches.length === 0 || selectedBranches.includes(branch);

                if (matchesSearch && matchesBranch) {
                    row.style.display = '';
                    groupStock += stock;
                    totalStock += stock;
                    visibleModels.add(model);
                    visibleBranches.add(branch);
                    visibleVariants.add(variant);
                    groupVisible = true;
                    hasVisibleRows = true;
                } else {
                    row.style.display = 'none';
                }
            });

            if (groupVisible) {
                group.style.display = '';
                group.querySelector('.model-count').textContent = groupStock;
            } else {
                group.style.display = 'none';
            }
        });
    } else {
        document.querySelectorAll('.flat-row').forEach(row => {
            const model = row.dataset.model;
            const branch = row.dataset.branch;
            const variant = row.dataset.variant;
            const color = row.dataset.color;
            const stock = parseInt(row.querySelector('.stock-value').textContent);

            const matchesSearch = !searchText ||
                model.toLowerCase().includes(searchText) ||
                variant.toLowerCase().includes(searchText) ||
                color.toLowerCase().includes(searchText) ||
                branch.toLowerCase().includes(searchText);

            const matchesBranch = selectedBranches.length === 0 || selectedBranches.includes(branch);

            if (matchesSearch && matchesBranch) {
                row.style.display = '';
                totalStock += stock;
                visibleModels.add(model);
                visibleBranches.add(branch);
                visibleVariants.add(variant);
                hasVisibleRows = true;
            } else {
                row.style.display = 'none';
            }
        });
    }

    // Update stats
    document.getElementById('statTotal').textContent = totalStock;
    document.getElementById('statModels').textContent = visibleModels.size;
    document.getElementById('statBranches').textContent = visibleBranches.size;
    document.getElementById('statVariants').textContent = visibleVariants.size;

    // Show/hide no results
    const noResults = document.getElementById('noResults');
    if (!hasVisibleRows) {
        document.getElementById('groupedView').classList.add('hidden');
        document.getElementById('flatView').classList.add('hidden');
        noResults.classList.remove('hidden');
    } else {
        noResults.classList.add('hidden');
        if (currentView === 'grouped') {
            document.getElementById('groupedView').classList.remove('hidden');
        } else {
            document.getElementById('flatView').classList.remove('hidden');
        }
    }
}

// Sort flat view
function sortFlat(colIndex) {
    const tbody = document.getElementById('flatTableBody');
    const rows = Array.from(tbody.querySelectorAll('.flat-row:not([style*="display: none"])'));

    sortOrder[colIndex] = !sortOrder[colIndex];
    const asc = sortOrder[colIndex];

    rows.sort((a, b) => {
        let aVal, bVal;
        if (colIndex === 4) {
            aVal = parseInt(a.cells[colIndex].querySelector('.stock-value').textContent);
            bVal = parseInt(b.cells[colIndex].querySelector('.stock-value').textContent);
        } else {
            aVal = a.cells[colIndex].textContent.trim().toLowerCase();
            bVal = b.cells[colIndex].textContent.trim().toLowerCase();
        }
        return asc ? (aVal > bVal ? 1 : -1) : (aVal < bVal ? 1 : -1);
    });

    rows.forEach(row => tbody.appendChild(row));
}

// Clear filters
function clearFilters() {
    document.getElementById('searchBox').value = '';
    document.querySelectorAll('.branch-checkbox').forEach(cb => cb.checked = true);
    updateBranchFilter();
    applyAllFilters();
}

// Initialize - Apply Khammam filter on load
document.addEventListener('DOMContentLoaded', function() {
    applyAllFilters();
});
</script>

<style>
.chevron {
    transition: transform 0.2s;
}
.rotate-90 {
    transform: rotate(90deg);
}
.rotate-180 {
    transform: rotate(180deg);
}
.group-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
}
.group-content:not(.hidden) {
    max-height: 2000px;
}
@media print {
    .no-print { display: none; }
}
</style>
{% endblock %}
